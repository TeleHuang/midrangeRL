# 贡献指南

<cite>
**本文档中引用的文件**  
- [agents/base_agent.py](file://agents/base_agent.py)
- [agents/rule_based/__init__.py](file://agents/rule_based/__init__.py)
- [agents/learned/.gitkeep](file://agents/learned/.gitkeep)
- [env_gym/tensor_env.py](file://env_gym/tensor_env.py)
- [env_gym/gym_wrapper.py](file://env_gym/gym_wrapper.py)
- [env_gym/base_env.py](file://env_gym/base_env.py)
- [env_numpy/aerodynamic.py](file://env_numpy/aerodynamic.py)
- [env_numpy/missile_guidance.py](file://env_numpy/missile_guidance.py)
- [env_numpy/game_events.py](file://env_numpy/game_events.py)
- [env_numpy/numpy_env.py](file://env_numpy/numpy_env.py)
- [rewards/base_reward.py](file://rewards/base_reward.py)
- [rewards/presets/__init__.py](file://rewards/presets/__init__.py)
- [config.py](file://config.py)
- [train.py](file://train.py)
- [game_play.py](file://game_play.py)
- [visualization.py](file://visualization.py)
- [tests/test_tensor_env.py](file://tests/test_tensor_env.py)
- [tests/test_tensor_env_v2.py](file://tests/test_tensor_env_v2.py)
- [.gitignore](file://.gitignore)
- [.gitattributes](file://.gitattributes)
- [README.md](file://README.md)
</cite>

## 目录
1. [代码提交规范](#代码提交规范)
2. [构建产物与文件排除策略](#构建产物与文件排除策略)
3. [跨平台换行符处理规则](#跨平台换行符处理规则)
4. [Pull Request模板与代码审查流程](#pull-request模板与代码审查流程)
5. [版本发布周期](#版本发布周期)
6. [扩展开发指南](#扩展开发指南)

## 代码提交规范

本项目遵循严格的代码质量标准，所有贡献必须符合以下规范。

### Python代码风格（PEP8）

所有Python代码必须严格遵守PEP8编码规范。建议使用`black`和`flake8`工具进行格式化和检查。代码应具备良好的可读性，包括：
- 使用4个空格进行缩进
- 每行代码不超过79个字符
- 正确使用空格分隔操作符和逗号
- 合理的函数和类的长度控制
- 遵循命名约定（小写加下划线用于变量和函数，驼峰式用于类名）

### 类型注解要求

本项目强制要求使用类型注解以提高代码可维护性和减少运行时错误。所有函数和方法必须包含完整的类型提示，包括：
- 函数参数的类型声明
- 返回值的类型声明
- 模块级变量的类型声明
- 使用`typing`模块中的`Optional`、`Union`、`Dict`、`List`等泛型类型

示例：
```python
def example_function(param1: str, param2: Optional[int] = None) -> Dict[str, Any]:
    pass
```

### 单元测试覆盖率标准

所有新功能和修改必须附带相应的单元测试，测试覆盖率需达到80%以上。测试应覆盖：
- 正常执行路径
- 边界条件和异常情况
- 错误输入处理
- 性能关键路径

测试文件应放置在`tests/`目录下，遵循`test_<module_name>.py`的命名约定。测试应使用`pytest`框架编写，并确保在不同环境下可重复执行。

**Section sources**
- [tests/test_tensor_env.py](file://tests/test_tensor_env.py#L1-L139)
- [tests/test_tensor_env_v2.py](file://tests/test_tensor_env_v2.py)

## 构建产物与文件排除策略

### .gitignore文件排除规则

`.gitignore`文件定义了不应纳入版本控制的文件类型和目录，主要包括：

- **Python编译产物**：`__pycache__/`, `*.py[cod]`, `*$py.class`
- **C扩展模块**：`*.so`
- **分发和打包产物**：`build/`, `dist/`, `*.egg-info/`, `MANIFEST`
- **虚拟环境**：`.env`, `.venv`, `env/`, `venv/`
- **IDE配置**：`.idea/`, `.vscode/`
- **测试和覆盖率报告**：`htmlcov/`, `.coverage`, `coverage.xml`
- **依赖管理锁文件**：注释状态的`Pipfile.lock`, `poetry.lock`, `pdm.lock`
- **本地配置**：`local_settings.py`, `db.sqlite3`
- **静态分析缓存**：`.mypy_cache/`, `.pytype/`, `.pyre/`

这些规则确保了仓库的整洁性，避免了敏感信息和平台特定文件的意外提交。

### 构建产物管理策略

项目采用清晰的构建产物管理策略：
- 所有生成的文件和临时数据都应放置在明确排除的目录中
- 不应将任何二进制产物或编译结果提交到版本控制
- 依赖管理采用声明式方法，基础依赖在文档中说明，具体版本锁定文件暂不纳入版本控制以保持灵活性
- 测试产物和覆盖率报告应在本地生成和查看，不提交到仓库

**Section sources**
- [.gitignore](file://.gitignore#L1-L161)

## 跨平台换行符处理规则

### .gitattributes文件配置

`.gitattributes`文件定义了跨平台换行符处理规则，确保在不同操作系统间协作时的一致性：

```
* text=auto
```

此配置的含义是：
- 所有文本文件由Git自动检测并进行换行符规范化
- 提交时，所有换行符将被转换为LF（`\n`）
- 检出时，根据操作系统自动转换为适当的换行符（Windows使用CRLF，Unix-like系统使用LF）

这一规则解决了Windows和Unix-like系统间换行符差异导致的"文件被修改"问题，保证了代码在不同开发环境中的兼容性。

**Section sources**
- [.gitattributes](file://.gitattributes#L1-L3)

## Pull Request模板与代码审查流程

### Pull Request模板

所有Pull Request应遵循以下模板结构：

```
## 描述
简要说明本次更改的目的和解决的问题。

## 相关问题
关联的issue编号（如有）。

## 变更内容
- 列出主要的变更点
- 说明架构或设计的变更

## 测试方法
描述如何验证本次更改：
- 单元测试覆盖情况
- 手动测试步骤
- 边界条件测试

## 部署说明
如有特殊部署要求，请在此说明。
```

### 代码审查流程

代码审查流程遵循以下步骤：
1. **自动检查**：PR创建后，CI系统自动运行代码格式检查、类型检查和单元测试
2. **初步审查**：至少一名核心成员进行技术审查，关注代码质量、设计合理性和测试覆盖
3. **讨论与修改**：根据审查意见进行必要的修改和讨论
4. **最终批准**：满足所有要求后，由审查者批准合并
5. **合并**：通过CI检查后，由维护者合并到主分支

审查重点包括：
- 是否符合PEP8规范
- 类型注解的完整性
- 测试覆盖率和质量
- 对现有功能的兼容性
- 文档更新的同步

## 版本发布周期

项目采用敏捷开发模式，版本发布周期如下：
- **开发周期**：功能在`main`分支上持续开发
- **版本标记**：重要功能完成并通过全面测试后，打上语义化版本标签（如`v1.0.0`）
- **发布频率**：根据功能完成情况和稳定性，每2-4周发布一个稳定版本
- **版本支持**：维护最近两个主版本的安全更新和关键bug修复

发布前必须完成：
- 全面的回归测试
- 文档更新
- 示例代码验证
- 性能基准测试

## 扩展开发指南

### 贡献新智能体

鼓励贡献新的智能体（Agent），需遵循以下原则：
- 继承`agents.base_agent.BaseAgent`抽象基类
- 实现`act()`和`reset()`抽象方法
- 支持批量操作（多环境并行）
- 保持与`env_gym`接口的完全兼容
- 提供清晰的文档和示例

新智能体应放置在`agents/`目录下的适当子目录中（如规则型智能体在`rule_based/`，学习型在`learned/`）。

### 贡献奖励函数

奖励函数的扩展应：
- 继承`rewards.base_reward.BaseReward`抽象基类
- 实现`compute()`抽象方法
- 遵循统一的接口设计原则
- 提供可配置的参数
- 包含充分的单元测试

奖励函数应放置在`rewards/`目录下，复杂的奖励策略可组织为子模块。

### 贡献物理模型

物理模型的扩展包括气动力学、导弹制导等，应：
- 保持与现有`TensorAerodynamic`和`TensorMissileGuidance`模块的接口兼容
- 确保数值稳定性和物理合理性
- 提供参数化配置接口
- 包含性能基准测试

新物理模型应放置在`env_gym/`或`env_numpy/`相应目录中，确保CPU和GPU版本的同步更新。

### 架构兼容性保证

所有扩展必须保证与现有架构的兼容性：
- 遵循统一的实体槽位系统
- 支持多环境并行处理
- 保持Gymnasium接口兼容性
- 不破坏现有的观察空间和动作空间定义
- 通过`tests/`目录下的所有相关测试

**Section sources**
- [agents/base_agent.py](file://agents/base_agent.py#L1-L118)
- [env_gym/base_env.py](file://env_gym/base_env.py#L1-L96)
- [rewards/base_reward.py](file://rewards/base_reward.py#L1-L103)
- [env_gym/tensor_env.py](file://env_gym/tensor_env.py#L1-L772)
- [env_numpy/aerodynamic.py](file://env_numpy/aerodynamic.py#L1-L239)
- [env_numpy/missile_guidance.py](file://env_numpy/missile_guidance.py#L1-L77)
- [train.py](file://train.py#L1-L374)